let RepsolRegister={url:"/bin/repsol/gigya/register.json",emailNotUsed:!0,vToken:"",emailBackUp:"",uid:"",passBackUp:"",init:function(){RepsolRegister.events()},events:function(){$("form.register-form").each(function(){let s=$(this);s.find("input").change(function(){RepsolRegister.checkContent(s)}),s.find("#userType").change(function(){("Profesional_Taller"===$("#userType").val()?($(".profesional").parent(".input.rp-input-repsol").removeClass("d-none"),$(".distributor")):("Distribuidor_Cliente"===$("#userType").val()?$(".distributor").parent(".input.rp-input-repsol").removeClass("d-none"):$(".distributor").parent(".input.rp-input-repsol").addClass("d-none"),$(".profesional"))).parent(".input.rp-input-repsol").addClass("d-none")}),s.on("click",".js-send-register-form",function(e){e.preventDefault(),RepsolRegister.submitInfo(s)}),s.on("blur","input[name='password']",function(){Repsol.forms.validate.InputPassword($(this),!0)}),s.on("blur","input[name='passwordConfirm']",function(){Repsol.forms.validate.InputPassword($(this),!0);var e=$(s).find("input[name='passwordConfirm']"),t=$(e).closest(".cmp-form");$(s).find("input[name='passwordConfirm']").val()==$(s).find("input[name='password']").val()?($(e).attr("data-status",!0),t.find(".error-msg-used").addClass("d-none"),t.addClass("valid"),t.removeClass("error")):($(e).attr("data-status",!1),t.find(".error-msg-used").removeClass("d-none"),t.removeClass("valid"),t.addClass("error"))}),s.find("#emailRegister").on("input",function(){Repsol.forms.validate.InputEmail($(this)),"true"==$(this).attr("data-status")&&RepsolRegister.validateGigyaEmail($(this))})}),$("#registerAuxMsgModal").on("show.bs.modal",function(e){$(this).addClass("backdrop")}),$("#registerAuxMsgModal").on("hidden.bs.modal",function(e){var t=$(this),t=(t.removeClass("backdrop"),t.parent().closest(".modal"));0<t.length&&!$(document).find("body").hasClass("modal-open")&&t.hasClass("show")&&$(document).find("body").addClass("modal-open")}),$("#registerAuxMsgModal").on("click",function(e){$(e.target).hasClass("register-aux-msg-modal")&&$(this).modal("hide")}),$("form.validation-code-from").each(function(){let t=$(this);t.on("click",".js-send-register-form",function(e){e.preventDefault(),RepsolRegister.sendCode(t)})})},autoSelectCountry:function(){var e=JSON.parse(RepsolRegister.getCookie("country-selected-rp")).countryId;document.querySelector(`.register-component .form-ecommerce-content .register-form select[name="country"] option[data-id="${e.toLowerCase()}"]`).selected=!0},getCookie:function(e){var t,s=e+"=";for(t of decodeURIComponent(document.cookie).split(";")){let e=t;for(;e.startsWith(" ");)e=e.substring(1);if(e.startsWith(s))return e.substring(s.length,e.length)}return""},checkContent:function(e){var t=e.find("input[name='name']"),s=e.find("input[name='surname']"),a=e.find("input[name='email']"),r=e.find("input[name='password']"),o=e.find("select[name='country']"),n=e.find("select[name='user-type']"),i=e.find("input[name='conditions-policies']"),l=e.find("input[name='policy-cesion-consent']");t.val().length&&s.val().length&&a.val().length&&r.val().length&&""!==o.val()&&""!==n.val()&&i.is(":checked")&&l.is(":checked")?e.attr("data-status",!0):e.attr("data-status",!1)},validateGigyaEmail:function(s){var e=$(s).val();gigyaUtilsLubs.services.checkEmailExist(e).then(e=>{var t=$(s).closest(".cmp-form");e?($(s).attr("data-status",!0),t.find(".error-msg-used").addClass("d-none"),t.addClass("valid"),t.removeClass("error"),RepsolRegister.emailNotUsed=!0):($(s).attr("data-status",!1),t.find(".error-msg-used").removeClass("d-none"),t.removeClass("valid"),t.addClass("error"),RepsolRegister.emailNotUsed=!1)}).catch(e=>{console.error("Hubo un error al verificar el email:",e.message)})},submitInfo:function(e){var t=e.find("input[name='name']"),s=e.find("input[name='surname']"),a=e.find("input[name='email']"),r=e.find("input[name='password']"),o=e.find("input[name='passwordConfirm']"),n=e.find("select[name='country']"),i=e.find("select[name='user-type']"),l=e.find("input[name='conditions-policies']"),d=e.find("input[name='policy-cesion-consent']"),s=(t.length&&Repsol.forms.validate.InputName(t),s.length&&Repsol.forms.validate.InputSurname(s),a.length&&(Repsol.forms.validate.InputEmail(a),"true"==$(a).attr("data-status"))&&RepsolRegister.validateGigyaEmail(a),r.length&&Repsol.forms.validate.InputPassword(r,!0),o.length&&r.length&&(o.attr("data-status",!1),(t=o.closest(".cmp-form")).find(".error-msg-required").addClass("d-none"),o.val()==r.val()?(o.attr("data-status",!0),t.addClass("valid"),t.removeClass("error"),t.find(".error-msg-notmatch").addClass("d-none")):(o.attr("data-status",!1),t.removeClass("valid"),t.find(".error-msg-format").removeClass("d-none"),t.find(".error-msg-notmatch").removeClass("d-none"),t.addClass("error"))),n.closest(".cmp-form")),t=(""!==n.val()?(s.find(".error-msg-required").addClass("d-none"),n.attr("data-status","true"),s.addClass("valid"),s.removeClass("error")):(s.find(".error-msg-required").removeClass("d-none"),n.attr("data-status","false"),s.removeClass("valid"),s.addClass("error")),i.closest(".cmp-form")),c=(""!==i.val()?(i.attr("data-status","true"),t.find(".error-msg-required").addClass("d-none"),t.addClass("valid"),t.removeClass("error")):(i.attr("data-status","false"),t.find(".error-msg-required").removeClass("d-none"),t.removeClass("valid"),t.addClass("error")),i.length&&(t=(s=e.find("input[name='ctc']")).closest(".cmp-form"),c=e.find("input[name='userCode']"),t.find(".error-msg-required").addClass("d-none"),"Profesional_Taller"===i.val()?(c.attr("data-status",!1),s.attr("data-status",!0),""!==c.val()?(c.attr("data-status",!0),t.addClass("valid"),t.removeClass("error")):(c.attr("data-status",!1),t.removeClass("valid"),t.find(".error-msg-format").removeClass("d-none"),t.addClass("error"))):"Distribuidor_Cliente"===i.val()?(c.attr("data-status",!0),s.attr("data-status",!1),""!==s.val()&&s.val().length<11?(s.attr("data-status",!0),t.addClass("valid"),t.removeClass("error")):(s.attr("data-status",!1),t.removeClass("valid"),t.find(".error-msg-format").removeClass("d-none"),t.addClass("error"))):(i.attr("data-status",!1),t.removeClass("valid"),t.find(".error-msg-format").removeClass("d-none"),t.addClass("error"))),l.length&&Repsol.forms.validate.CheckLegal(l),d.length&&Repsol.forms.validate.CheckLegal(d),"true"===e.find("input[name='name']").attr("data-status")),s="true"===e.find("input[name='surname']").attr("data-status"),t="true"===a.attr("data-status"),l="true"===r.attr("data-status"),d="true"===o.attr("data-status"),a="true"===n.attr("data-status"),r="true"===i.attr("data-status"),o="true"===e.find("input[name='userCode']").attr("data-status"),n="true"===e.find("input[name='ctc']").attr("data-status");let m=!1;(m=c&&s&&t&&RepsolRegister.emailNotUsed&&l&&d&&a&&r&&o&&n?!0:m)?(e.closest(".form-ecommerce-content").attr("data-status","ok"),RepsolRegister.sendData(e)):RepsolRegister.analytics.error(e)},sendData:function(r){RepsolRegister.setLoader(!0,r);var e=r.find("input[name='name']"),t=r.find("input[name='surname']"),s=r.find("input[name='email']"),a=r.find("input[name='password']"),o=r.find("select[name='country']"),n=r.find("select[name='country']").find("option:selected").data("id"),i=r.find("select[name='user-type']"),l=r.find("input[name='userCode']"),d=r.find("input[name='ctc']"),e=e.val(),t=t.val(),s=s.val(),a=a.val(),o=o.val(),i=i.val(),l=l.val(),d=d.val(),c=$("html").attr("lang"),e={firstName:e,lastName:t,email:RepsolRegister.emailBackUp=s,password:RepsolRegister.passBackUp=a,country:o,countryID:n,userType:i,userCode:l,ctc:d,operation:"create",lang:c},t=JSON.stringify(e),s=(RepsolRegister.getEmailModal(),new XMLHttpRequest);s.addEventListener("readystatechange",function(){var e,t,s,a;4===this.readyState&&(200==this.status?0==(a=(e=JSON.parse(this.responseText)).errorCode)||206002==a||206006==a?void 0===e.vToken||void 0===e.UID?console.log("response.vToken or UID undefinded"):(RepsolRegister.vToken=e.vToken,RepsolRegister.uid=e.UID,""!=RepsolRegister.vToken&&""!=RepsolRegister.uid&&(RepsolRegister.setLoader(!1,r),$(".register-block").addClass("hidden"),$(".code-block").removeClass("hidden")),Repsol.Analytics.clickRegister(),t={method:"password",component_name:"card de login",customer_type:Repsol.AnalyticsRomProd.Getters.getLoggedUserType(),funnel_action:"create_account_ok",funnel_step:"2",funnel_type:"register_long",service:"lubricantes"},Repsol.AnalyticsRomProd.AccountRegisterRomProd($(this),t)):1==a?(RepsolRegister.setLoader(!1,r),t=a-1,0<(s=$("#registerAuxMsgModal")).length&&0<s.find(".modal-content.modal-case-"+t).length&&(s.find(`.modal-content:not(.modal-case-${t})`).addClass("d-none"),s.find(".modal-content.modal-case-"+t).removeClass("d-none"),s.modal("show")),RepsolRegister.analytics.error(r,e)):2==a?(RepsolRegister.setLoader(!1,r),s=(t=r.find("input[name='ctc']")).closest(".cmp-form"),t.attr("data-status",!1),s.removeClass("valid"),s.find(".error-msg-format").removeClass("d-none"),s.addClass("error")):(RepsolRegister.setLoader(!1,r),RpAlert.msgError(r.attr("data-msg-error")),RepsolRegister.analytics.error(r,e)):(a=JSON.parse(this.responseText),RepsolRegister.setLoader(!1,r),RpAlert.msgError(r.attr("data-msg-error")),RepsolRegister.analytics.error(r,a)))}),s.open("POST",RepsolRegister.url),s.setRequestHeader("Content-Type","application/json"),s.send(t)},sendCode:function(a){var e={code:a.find("input[name='code']").val(),email:RepsolRegister.emailBackUp,vToken:RepsolRegister.vToken,UID:RepsolRegister.uid,operation:"sendCode"},e=JSON.stringify(e),t=new XMLHttpRequest;t.addEventListener("readystatechange",function(){var e,t,s;4===this.readyState&&(200==this.status?0==(t=(e=JSON.parse(this.responseText)).errorCode)?(s={loginID:RepsolRegister.emailBackUp,password:RepsolRegister.passBackUp},gigya.accounts.login(s),gigyaUtilsLubs.checkUserIsLogged(),RepsolRegister.hideModal(),location.reload()):(1==t||2==t?(RepsolRegister.setLoader(!1,a),s=t-1,0<(t=$("#registerAuxMsgModal")).length&&0<t.find(".modal-content.modal-case-"+s).length&&(t.find(`.modal-content:not(.modal-case-${s})`).addClass("d-none"),t.find(".modal-content.modal-case-"+s).removeClass("d-none"),t.modal("show"))):(RepsolRegister.setLoader(!1,a),RpAlert.msgError(a.attr("data-msg-error"))),RepsolRegister.analytics.error(a,e)):(s=JSON.parse(this.responseText),RepsolRegister.setLoader(!1,a),RpAlert.msgError(a.attr("data-msg-error")),RepsolRegister.analytics.error(a,s)))}),t.open("POST",RepsolRegister.url),t.setRequestHeader("Content-Type","application/json"),t.send(e)},getInfoUser:function(e,t,s){RepsolRegister.emailBackUp=e,RepsolRegister.uid=t,RepsolRegister.passBackUp=s},resendCode:function(){var e={email:RepsolRegister.emailBackUp,UID:RepsolRegister.uid,operation:"resendCode"},e=JSON.stringify(e);$.ajax({type:"POST",url:RepsolRegister.url,contentType:"application/json",data:e,cache:!1,success:function(e){var t=e.errorCode;0==t?RepsolRegister.vToken=e.vToken:console.log("Error "+t)},error:function(e,t,s){console.log("Error: "+s)}})},getEmailModal:function(){document.getElementById("email-reference-register").textContent=RepsolRegister.emailBackUp},hideModal:function(){var e=document.getElementById("registerLoginModal"),t=document.getElementById("register-login-modal-backdrop");RepsolRegister.getEmailModal(),e.classList.remove("show"),e.classList.remove("hide"),t.classList.remove("show")},resetInfo:function(e){e.find(".cmp-form-text input").val(""),e.find(".cmp-form-text input").attr("data-status","false"),e.closest(".form-ecommerce-content").attr("data-status","ko")},setLoader:function(e,t){let s=$(document).find("body");0<t.closest(".modal").length&&(s=t.closest(".modal")),Repsol.utils.setLoader(e,s)},analytics:{success:function(e,t){e={event:"account_register",funnel_type:"register_long",funnel_action:"create_account_ok",funnel_step:"02",method:"password",component_position:void 0,component_name:"card de login",account_action:"register",service:"tienda",loyalty_cesion:0<e.find("input[name='policy-cesion-consent']").length?e.find("input[name='policy-cesion-consent']").is(":checked")?"true":"false":void 0,loyalty_cesion_terceros:0<e.find("input[name='policy-cesion-third-consent']").length?e.find("input[name='policy-cesion-third-consent']").is(":checked")?"true":"false":void 0};Repsol.Analytics.ES.form(e)},error:function(e,t){t={event:"account_error",error_type:Repsol.Analytics.ES.getErrorType(e),error_description:t&&t.errorMessage?t.errorMessage:Repsol.Analytics.ES.getFormErrorFields(e),funnel_type:"register_long",funnel_action:"create_account_form",funnel_step:"01",method:"password",account_action:"error",service:"tienda",loyalty_cesion:0<e.find("input[name='policy-cesion-consent']").length?e.find("input[name='policy-cesion-consent']").is(":checked")?"true":"false":void 0,loyalty_cesion_terceros:0<e.find("input[name='policy-cesion-third-consent']").length?e.find("input[name='policy-cesion-third-consent']").is(":checked")?"true":"false":void 0,component_position:void 0,component_name:"card de login"},Repsol.Analytics.ES.form(t),e={method:"password",component_name:"card de login",customer_type:Repsol.AnalyticsRomProd.Getters.getLoggedUserType(),funnel_action:"create_account_form",funnel_step:"1",funnel_type:"register_long",service:"lubricantes"};Repsol.AnalyticsRomProd.AccountErrorRomProd($(".register-form"),e)}}};$(document).ready(function(){RepsolRegister.init()});